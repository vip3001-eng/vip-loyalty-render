<!doctype html>
<html lang="ar" dir="rtl">
<head>`n<meta charset="UTF-8">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VIP â€” ط¹ظ…ظٹظ„ ط¬ط¯ظٹط¯</title>
  <link rel="stylesheet" href="/css/styles.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="card">
    <div class="header">
      <a class="back-btn" href="/">ط±ط¬ظˆط¹</a>
      <!-- ط¨ط¯ظˆظ† ط´ط¹ط§ط± ظپظٹ طµظپط­ط§طھ ط§ظ„ط¹ظ…ظ„ط§ط، -->
      <div style="width:120px"></div>
    </div>

      <div class="page-title">
        <h2>ظ…ط±ط­ط¨ط§ظ‹ ط¨ظƒ ظ„ط£ظˆظ„ ظ…ط±ط© ظ…ط¹ظ†ط§</h2>
        </div>

      <div id="notice" class="notice" style="display:none"></div>

      <form class="form" id="loyalForm">
        <div class="field">
          <label>ط§ظ„ط§ط³ظ… *</label>
          <input name="name" required/>
        </div>
        <div class="field">
          <label>ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„ *</label>
          <input name="phone" inputmode="tel" required/>
        </div>

        <div class="field">
          <label>ظ†ظˆط¹ ط§ظ„ط³ظٹط§ط±ط© *</label>
          <input name="car_type" required/>
        </div>

        <div class="field">
          <label>ظ…ظˆط¯ظٹظ„ ط§ظ„ط³ظٹط§ط±ط© *</label>
          <input name="car_model" required/>
        </div>

        <div class="row2">
          <div class="field">
            <label>ط­ط±ظˆظپ ط§ظ„ظ„ظˆط­ط© (ط¹ط±ط¨ظٹ) *</label>
            <input name="plate_letters_ar" required/>
          </div>
          <div class="field">
            <label>ط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط© (ط¹ط±ط¨ظٹ/ط¥ظ†ط¬ظ„ظٹط²ظٹ) *</label>
            <input name="plate_numbers" class="mono" required/>
          </div>
        </div>

        <div class="field">
          <label>ط§ظ„طھظ‚ظٹظٹظ… *</label>
          <div class="stars" id="stars">
            <button type="button" class="star" data-v="1">âک…</button>
            <button type="button" class="star" data-v="2">âک…</button>
            <button type="button" class="star" data-v="3">âک…</button>
            <button type="button" class="star" data-v="4">âک…</button>
            <button type="button" class="star" data-v="5">âک…</button>
          </div>
          <input type="hidden" name="rating" id="rating" required/>
        </div>

        <div class="field">
          <label>ظ…ظ„ط§ط­ط¸ط§طھ</label>
          <textarea name="notes"></textarea>
        </div>

        <button class="btn btn-primary" type="submit">طھظ…</button>
      </form>
    </div>
  </div>

<div class="modal-backdrop" id="modalBack" data-go-home="1" onclick="if(event.target.id==='modalBack') closeModal()">
  <div class="modal qr-modal">
      <h3 id="modalTitle">ظˆط¬ظ‘ظ‡ ط§ظ„ط¨ط§ط±ظƒظˆط¯ ظ„ظ„ظ…ط­ط§ط³ط¨ ظ„ظ„ط§ط¹طھظ…ط§ط¯</h3>
      <div class="qr-wrap">
        <img id="qrImg" class="qr-img" alt="QR"/>
      </div>
      <p class="small" id="modalHint">ط¨ط¹ط¯ ط§ط¹طھظ…ط§ط¯ ط§ظ„ظ…ط­ط§ط³ط¨ ط³طھط¸ظ‡ط± ط±ط³ط§ظ„ط© ط¥ط¶ط§ظپط© ط§ظ„ظ†ظ‚ط§ط·.</p>
      <div id="carsBlock" style="display:none">
        <div class="cars-progress" id="carsProgress" aria-label="ط´ط±ظٹط· ط§ظ„طھظ‚ط¯ظ‘ظ…"></div>
      </div>
      <div id="afterApprove" class="after-approve" style="display:none">
        <p id="afterApproveText" class="small" style="margin:0 0 10px 0"></p>
        <div class="social" aria-label="ط±ظˆط§ط¨ط· ط§ظ„طھظˆط§طµظ„">
          <a class="icon" id="aaWaLink" href="#" target="_blank" rel="noopener" aria-label="ظˆط§طھط³ ط£ط¨"><span id="aaWaI"></span></a>
          <a class="icon" id="aaSnapLink" href="#" target="_blank" rel="noopener" aria-label="ط³ظ†ط§ط¨ ط´ط§طھ"><span id="aaSnI"></span></a>
          <a class="icon" id="aaTkLink" href="#" target="_blank" rel="noopener" aria-label="طھظٹظƒ طھظˆظƒ"><span id="aaTkI"></span></a>
          <a class="icon" id="aaMapsLink" href="#" target="_blank" rel="noopener" aria-label="ظ‚ظˆظ‚ظ„ ظ…ط§ط¨"><span id="aaMapI"></span></a>
        </div>
      </div>
      <button class="btn btn-ghost" onclick="closeModal()">ط¥ط؛ظ„ط§ظ‚</button>
    </div>
  </div>

<script src="/js/common.js"></script>
<script>
  setStars("#stars", "#rating");

  function carSvg(){
    return `
<svg viewBox="0 0 64 32" xmlns="http://www.w3.org/2000/svg" fill="none">
  <!-- body -->
  <path d="M10 19l4-9c.6-1.4 2-2.3 3.6-2.3h28.8c1.6 0 3 .9 3.6 2.3l4 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M6 19h52a4.5 4.5 0 0 1 4.5 4.5V26H1.5v-2.5A4.5 4.5 0 0 1 6 19Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
  <!-- windows -->
  <path d="M19 10h10l-2 7H15l4-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" opacity=".75"/>
  <path d="M33 10h12l4 7H31l2-7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" opacity=".75"/>
  <!-- lights -->
  <path d="M3.5 23h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
  <path d="M55.5 23h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".7"/>
  <!-- wheels -->
  <circle cx="18" cy="26" r="3.2" fill="currentColor"/>
  <circle cx="46" cy="26" r="3.2" fill="currentColor"/>
</svg>
`;
  }

  function renderCars(pointsNow, pointsLimit, pointsPerVisit){
    const wrap = $("#carsProgress");
    const block = $("#carsBlock");
    if(!wrap || !block) return;

    const per = Number(pointsPerVisit || 10) || 10;
    const limit = Number(pointsLimit || 50) || 50;
    const total = Math.max(1, Math.ceil(limit / per));
    const filled = Math.max(0, Math.min(total, Math.floor((Number(pointsNow) || 0) / per)));

    wrap.innerHTML = "";
    for(let i=0;i<total;i++){
      const el = document.createElement("span");
      el.className = "car-chip" + (i < filled ? " on" : "");
      el.innerHTML = carSvg();
      wrap.appendChild(el);
    }
    block.style.display = "block";
  }


  document.addEventListener("DOMContentLoaded", ()=>{
    if($("#aaWaI")) $("#aaWaI").innerHTML = iconWhats();
    if($("#aaSnI")) $("#aaSnI").innerHTML = iconSnap();
    if($("#aaTkI")) $("#aaTkI").innerHTML = iconTiktok();
    if($("#aaMapI")) $("#aaMapI").innerHTML = iconMaps();
  });

  $("#loyalForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    hideNotice();
    const fd = new FormData(e.target);
    const body = Object.fromEntries(fd.entries());
    // Client-side validation for the most common issue: rating not selected
    if(!body.rating){
      showNotice("ط§ط®طھط± ط§ظ„طھظ‚ظٹظٹظ… ط¨ط§ظ„ظ†ط¬ظˆظ… ط«ظ… ط§ط¶ط؛ط· طھظ….", "bad");
      return;
    }
    try{
      const r = await api("/api/customer/new/submit", "POST", body);
      if(!r.ok){
        if(r.error === "ALREADY_EXISTS"){
          showNotice("ظ‡ط°ظ‡ ط§ظ„ط¨ظٹط§ظ†ط§طھ ظ…ط³ط¬ظ„ط© ظ„ط¯ظٹظ†ط§ ظƒط¹ظ…ظٹظ„ ظˆظپظٹ. ط§ط¶ط؛ط· ط§ظ„ط²ط± ظ„ظ„ط§ظ†طھظ‚ط§ظ„.", "bad");
          const btn = document.createElement("a");
          btn.href = "/loyal.html";
          btn.className = "btn btn-ghost";
          btn.textContent = "ط§ظ„ط§ظ†طھظ‚ط§ظ„ ظ„طµظپط­ط© ط§ظ„ط¹ظ…ظٹظ„ ط§ظ„ظˆظپظٹ";
          btn.style.marginTop = "12px";
          btn.style.width = "100%";
          btn.style.display = "flex";
          btn.style.justifyContent = "center";
          btn.style.alignItems = "center";
          $("#notice").appendChild(btn);
          return;
        }
        showNotice(r.message || "طھط­ظ‚ظ‚ ظ…ظ† ط§ظ„ط­ظ‚ظˆظ„ ط§ظ„ظ…ط·ظ„ظˆط¨ط©.", "bad");
        return;
      }
      $("#qrImg").src = r.qrDataUrl;
      $("#modalTitle").textContent = "ظˆط¬ظ‘ظ‡ ط§ظ„ط¨ط§ط±ظƒظˆط¯ ظ„ظ„ظ…ط­ط§ط³ط¨ ظ„ظ„ط§ط¹طھظ…ط§ط¯";
      $("#afterApprove").style.display = "none";
      if($("#carsBlock")) $("#carsBlock").style.display = "none";
      const qrWrap = document.querySelector(".qr-wrap");
      if(qrWrap) qrWrap.style.display = "grid";
      $("#modalHint").style.display = "block";
      document.querySelector("#modalBack").dataset.goHome = "1";
      openModal();

      // Poll approval status
      pollApproved(r.visitId);
    }catch(err){
      showNotice("ط­ط¯ط« ط®ط·ط£ ط؛ظٹط± ظ…طھظˆظ‚ط¹. ط£ط¹ط¯ ط§ظ„ظ…ط­ط§ظˆظ„ط©.", "bad");
    }
  });

  async function pollApproved(visitId){
  try{
    const maxMs = 5 * 60 * 1000; // 5 minutes
    const started = Date.now();
    const timer = setInterval(async ()=>{
      try{
        const res = await fetch(`/api/public/visit-status?visitId=${encodeURIComponent(visitId)}`);
        const data = await res.json();
        if(data && data.ok && data.approved){
          clearInterval(timer);
          // After approval/redeem
          $("#modalTitle").textContent = `ظ†ظ‚ط§ط·ظƒ ط§ظ„ط¢ظ† ${data.pointsNow}/${data.pointsLimit}`;
          const qrWrap2 = document.querySelector(".qr-wrap");
          if(qrWrap2) qrWrap2.style.display = "none";
          renderCars(data.pointsNow, data.pointsLimit, data.pointsPerVisit);
          $("#modalHint").style.display = "none";

          const t = (data.after_approve_text || "").trim();
          $("#afterApproveText").textContent = t || "طھط§ط¨ط¹ظ†ط§ ط¹ظ„ظ‰ ط­ط³ط§ط¨ط§طھظ†ط§ ظ„ظ„طھط­ط¯ظٹط«ط§طھ ظˆط§ظ„ط¹ط±ظˆط¶";
          $("#aaWaLink").href = data.social?.whatsapp || "#";
          $("#aaSnapLink").href = data.social?.snap || "#";
          $("#aaTkLink").href = data.social?.tiktok || "#";
          $("#aaMapsLink").href = data.social?.maps || "#";
          $("#afterApprove").style.display = "block";
        }else{
          // keep waiting
          if(Date.now() - started > maxMs){
            clearInterval(timer);
            $("#modalHint").textContent = "ط¥ط°ط§ ظ„ظ… ظٹطھظ… ط§ظ„ط§ط¹طھظ…ط§ط¯طŒ طھظˆط§طµظ„ ظ…ط¹ ط§ظ„ظ…ط­ط§ط³ط¨.";
          }
        }
      }catch(e){}
    }, 1500);
  }catch(err){}
}
</script>
</body>
</html>

