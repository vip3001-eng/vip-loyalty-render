<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">`n<meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VIP � ���� �������</title>
  <link rel="stylesheet" href="/css/styles.css?v=202601091251"/>
  <!-- ���� ������ ������: ����� ��� BarcodeDetector ���� common.js -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="card">
    <div class="topbar">
      <div class="lang">
        <span class="pill">�����</span>
      </div>
      <div class="lang">
        <button class="pill" id="btnLang">EN</button>
        <a class="pill" href="#" id="btnLogout">����</a>
      </div>
    </div>

    <div class="section">
      <div class="page-title" style="padding:0 0 10px">
        <h2 id="t1">���� ��������</h2>
        <p id="t2">���� QR �� ������ ������� ������ (���� + ����).</p>
      </div>

      <div id="notice" class="notice" style="display:none"></div>

      <div class="row2">
        <div class="kpi" style="padding:10px">
          <div id="reader" style="width:100%"></div>
          <div class="row2" style="margin-top:10px">
            <button class="btn btn-primary" id="btnCam" type="button">����� ��������</button>
            <button class="btn btn-ghost" id="btnStopCam" type="button" disabled>�����</button>
            <button class="btn btn-ghost" id="btnScanImage" type="button">������/��� ����</button>
            <input id="scanImageInput" type="file" accept="image/*" capture="environment" style="display:none" />
          </div>
          <div class="small" style="margin-top:8px" id="t3">��� �� ���� �������ǡ ���� ��� �������� �� ������ ������� ������.</div>
        </div>

        <div class="kpi" style="padding:10px">
          <div class="field">
            <label id="lPhone">��� ������</label>
            <input id="mPhone" inputmode="tel" placeholder="05xxxxxxxx"/>
          </div>
          <div class="field" style="margin-top:8px">
            <label id="lPlate">����� ������</label>
            <input id="mPlate" class="mono" placeholder="1234"/>
          </div>
          <button class="btn btn-ghost" id="btnManual" style="margin-top:10px">��� ����</button>
        </div>
      </div>
    </div>

    <div class="section" id="resultBox" style="display:none">
      <div class="page-title" style="padding:0 0 10px">
        <h2 id="tRes">����� �����</h2>
      </div>

      <div class="kpi">
        <div class="label" id="lCust">������</div>
        <div class="value" id="custName" style="font-size:16px">�</div>
        <div class="small" id="custMeta"></div>
        <div class="small" style="margin-top:8px">�������: <span id="visitRatingStars" class="stars-inline">�</span></div>
      </div>

      <div class="row2" style="margin-top:10px">
        <div class="kpi">
          <div class="label" id="lVisits">��� �������� (������)</div>
          <div class="value" id="visitsCount">�</div>
        </div>
        <div class="kpi">
          <div class="label" id="lPoints">������ �������</div>
          <div class="value" id="pointsNow">�</div>
          <div class="small" id="pointsMeta"></div>
        </div>
      </div>

      <div class="row2" style="margin-top:10px">
        <button class="btn btn-primary" id="btnApprove">������ �����</button>
        <button class="btn btn-ghost" id="btnRedeem">������� ������</button>
      </div>
    </div>

  </div>
</div>
  <script src="/vendor/html5-qrcode.min.js?v=202601091251"></script>
  <script src="/js/common.js?v=202601091251"></script>
<script>
  let lastVisit = null;
  let scanner = null;
  let lang = "ar";

function showActionStatus(msg, type=""){
  const el = document.querySelector("#actionStatus");
  if(!el) return;
  el.textContent = msg;
  el.className = "notice " + type;
  el.style.display = "block";
}

  const dict = {
    ar: {
      btnManual:"��� ����",
      approve:"������ �����",
      redeem:"������� ������",
      logout:"����",
      t1:"���� ��������",
      t2:"���� QR �� ������ ������� ������ (���� + ����).",
      t3:"��� �� ���� �������ǡ ������ ������� ������.",
      lPhone:"��� ������",
      lPlate:"����� ������",
      tRes:"����� �����",
      lCust:"������",
      lVisits:"��� �������� (������)",
      lPoints:"������ �������",
      msgFound:"�� ��� ������ �������.",
      msgBad:"QR ��� ���� �� �����.",
      msgNeed:"���� ��� ������ ������ ������.",
      msgNF:"�� ��� ������ ��� ������.",
      msgApp:"�� ������ �������.",
      msgRedeemOk:"�� ������� ������.",
      msgRedeemNo:(cur,need)=>`�� ���� ���������. ���� ������ ${cur}/${need}`
    },
    en: {
      btnManual:"Manual lookup",
      approve:"Approve visit",
      redeem:"Redeem points",
      logout:"Logout",
      t1:"QR Scanner",
      t2:"Scan QR or use manual (phone + plate).",
      t3:"If camera fails, use manual.",
      lPhone:"Phone",
      lPlate:"Plate numbers",
      tRes:"Result",
      lCust:"Customer",
      lVisits:"Approved visits",
      lPoints:"Current points",
      msgFound:"Visit loaded.",
      msgBad:"Invalid/expired QR.",
      msgNeed:"Enter phone and plate.",
      msgNF:"Not found.",
      msgApp:"Visit approved.",
      msgRedeemOk:"Redeemed.",
      msgRedeemNo:(cur,need)=>`Not enough points: ${cur}/${need}`
    }
  };

  function t(){ return dict[lang]; }
  function applyLang(){
    $("#btnLang").textContent = (lang==="ar") ? "EN" : "AR";
    $("#btnManual").textContent = t().btnManual;
    $("#btnApprove").textContent = t().approve;
    $("#btnRedeem").textContent = t().redeem;
    $("#btnLogout").textContent = t().logout;
    $("#t1").textContent = t().t1;
    $("#t2").textContent = t().t2;
    $("#t3").textContent = t().t3;
    $("#lPhone").textContent = t().lPhone;
    $("#lPlate").textContent = t().lPlate;
    $("#tRes").textContent = t().tRes;
    $("#lCust").textContent = t().lCust;
    $("#lVisits").textContent = t().lVisits;
    $("#lPoints").textContent = t().lPoints;
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang==="ar") ? "rtl" : "ltr";
  }

  async function guard(){
    const me = await api("/api/auth/me");
    if(!me.user || !["admin","cashier"].includes(me.user.role)) location.href="/admin-login.html";
    if(me.user.role==="admin") {
      // admin can still use cashier page; ok
    }
  }

  $("#btnLogout").addEventListener("click", async (e)=>{ e.preventDefault(); await api("/api/auth/logout","POST",{}); location.href="/"; });
  $("#btnLang").addEventListener("click", ()=>{ lang = (lang==="ar") ? "en" : "ar"; applyLang(); });

  $("#btnManual").addEventListener("click", async (e)=>{
    e.preventDefault();
    await lookupManual();
  });

  // Camera must be started by a user gesture on many mobile browsers
  $("#btnCam").addEventListener("click", async ()=>{ await startScanner(); });
  $("#btnStopCam").addEventListener("click", async ()=>{ await stopScanner(); });

  // Scan from an image (works even if camera is blocked)
  $("#btnScanImage").addEventListener("click", ()=>{
    const inp = $("#scanImageInput");
    if(inp) inp.click();
  });
  $("#scanImageInput").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    hideNotice();
    try{
      let decoded = null;

      if(window.Html5Qrcode){
        const tmpId = 'qr_img_' + Math.random().toString(16).slice(2);
        const tmp = document.createElement('div');
        tmp.id = tmpId;
        tmp.style.display = 'none';
        document.body.appendChild(tmp);
        const h = new Html5Qrcode(tmpId);
        try{
          decoded = await h.scanFile(file, true);
        } finally {
          try{ h.clear(); }catch(_e){}
          try{ tmp.remove(); }catch(_e){}
        }
      } else if('BarcodeDetector' in window){
        const img = await createImageBitmap(file);
        const det = new BarcodeDetector({formats:['qr_code']});
        const codes = await det.detect(img);
        decoded = (codes && codes[0] && codes[0].rawValue) ? codes[0].rawValue : null;
      } else {
        throw new Error('NO_SUPPORT');
      }

      if(!decoded) throw new Error('NO_CODE');
      playBeep();
      const r = await api('/api/visit/lookup','POST',{ qrText: decoded });
      if(r.ok){ applyLookup(r); showNotice(t().msgFound,'good'); }
      else{ showNotice(t().msgBad,'bad'); }
    }catch(err){
      const msg = (err && err.message === 'NO_SUPPORT')
        ? ((lang==='ar')?'��� ������� �� ���� ��� QR �� ����.':'Browser does not support scan-from-image.')
        : ((lang==='ar')?'���� ��� ������.':'Failed to scan image.');
      showNotice(msg,'bad');
    } finally {
      e.target.value = '';
    }
  });

  $("#btnApprove").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/approve","POST",{ visitId: lastVisit.id });
    showNotice(t().msgApp + ` � ����� ���� ${r.points.current_points}/50`, "good");
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} � Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
    // ��� �������� ���� ������ ������ ����� ����� ���
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  $("#btnRedeem").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/redeem","POST",{ customerId: lastVisit.customer_id, visitId: lastVisit.id }).catch(err=>err.data);
    if(!r.ok){
      showActionStatus(t().msgRedeemNo(r.current, r.need), "bad");
      return;
    }
    showNotice(t().msgRedeemOk + ` � ����� ���� ${r.points.current_points}/50`, "good");
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} � Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
    // ��� ��������� ���� ������ ������ ����� ����� ���
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  async function lookupManual(){
    hideNotice();
    const phone = $("#mPhone").value.trim();
    const plate_numbers = $("#mPlate").value.trim();
    if(!phone || !plate_numbers) return showActionStatus(t().msgNeed, "bad");
    const r = await api("/api/visit/lookup","POST",{ phone, plate_numbers }).catch(err=>err.data);
    if(!r.ok) return showActionStatus(t().msgNF, "bad");
    applyLookup(r);
  }

  async function applyLookup(r){
    lastVisit = r.visit;
    $("#resultBox").style.display="block";
    $("#custName").textContent = r.visit.customer_name;
    $("#custMeta").textContent = `Phone: ${r.visit.customer_phone} � Plate: ${r.visit.plate_letters_ar} ${r.visit.plate_numbers}`;
    // rating stars
    const rating = Number(r.visit.rating || 0);
    const stars = Array.from({length:5}).map((_,i)=> i<rating ? "?" : "?").join("");
    const rsEl = document.querySelector("#visitRatingStars");
    if(rsEl) rsEl.textContent = stars;
    $("#visitsCount").textContent = r.visitsCount;
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} � Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
  }

  async function refreshRedeemButton(){
    // cashiers can't read admin settings; use a tiny endpoint? reuse /api/admin/settings is admin-only. We'll hardcode by reading public settings is not enough.
    // workaround: redeem is enforced server-side; we disable button only visually using current points threshold 50 default.
    const can = Number($("#pointsNow").textContent || "0") >= 50;
    $("#btnRedeem").disabled = !can;
    $("#btnRedeem").style.opacity = can ? "1" : ".55";
  }

  async function startScanner(){
    hideNotice();
    if(!scanner) scanner = createQrScanner($("#reader"), async (decodedText)=>{
      playBeep();
      const r = await api("/api/visit/lookup","POST",{ qrText: decodedText });
      if(r.ok){
        applyLookup(r);
        showNotice(t().msgFound, "good");
      }else{
        showNotice(t().msgBad, "bad");
      }
    }, (err)=>{
      const isNotSecure = !!(err && (err.code==='NOT_SECURE' || err.name==='NOT_SECURE' || err.message==='NOT_SECURE'));
      const httpsUrl = suggestedHttpsUrl();

      if(isNotSecure){
        if(httpsUrl){
          const msg = (lang==="ar")
            ? `�� ��� ����� �������� ��� ������ ���� ���� (HTTP). ���� ������ �������� ������ ������. ��� �� ���� ������� ����: <button class="pill" id="openHttpsBtn" type="button">��� ��� HTTPS</button>`
            : `Camera requires HTTPS. Redirecting now. If not redirected, click: <button class="pill" id="openHttpsBtn" type="button">Open HTTPS</button>`;
          showNoticeHtml(msg, "bad");
          setTimeout(()=>{
            const b = document.getElementById('openHttpsBtn');
            if(b) b.addEventListener('click', ()=>{ location.href = httpsUrl; });
          }, 0);
        }else{
          showNotice((lang==="ar")
            ? `�� ��� ����� �������� ��� ������ ���� ����. ���� ��� https ��� ������ 3443 (����: https://${location.hostname}:3443).`
            : 'Camera requires HTTPS (port 3443).', "bad");
        }
        return;
      }
      // ��� ��� ������� �� ���� ��� QR ���������
      if(!(window.Html5Qrcode || ("BarcodeDetector" in window))){
        const m = (lang==="ar")
          ? "��� ������� �� ���� ��� QR ���������. ������ ������� ������ �� ���� ������ �� Chrome/Edge ����."
          : "This browser does not support QR scanning. Use manual input or open in a recent Chrome/Edge.";
        showNotice(m, "bad");
        return;
      }
      // ����� �������/������� ��������
      const n = (err && err.name) ? err.name : '';
      const msgAr = (n==='NotAllowedError' || n==='PermissionDeniedError')
        ? '�� ��� ��� ��������. �� ������� �������: Site settings > Camera > Allow �� ���� ������.'
        : (n==='NotFoundError')
          ? '�� ���� ������ ����� ��� ��� ������.'
          : (n==='NotReadableError')
            ? '�������� ������ ������ ���. ���� �� ����� ������ �������� �� ����.'
            : '���� ����� ��������. ���� ��� ������ �� Chrome/Edge ����� ���� ��������.';
      const msgEn = (n==='NotAllowedError' || n==='PermissionDeniedError')
        ? 'Camera permission denied. Allow it in Site Settings then refresh.'
        : (n==='NotFoundError')
          ? 'No camera found on this device.'
          : (n==='NotReadableError')
            ? 'Camera is in use by another app. Close it and retry.'
            : 'Failed to start camera. Try Chrome/Edge and allow permission.';
      const html = ((lang==="ar") ? msgAr : msgEn) + ` � <button class="pill" id="useImageScanBtn" type="button">${(lang==="ar")?'��� �� ����':'Scan from image'}</button>`;
      showNoticeHtml(html, "bad");
      setTimeout(()=>{ const b=document.getElementById('useImageScanBtn'); if(b) b.addEventListener('click', ()=>{ const inp=document.getElementById('scanImageInput'); if(inp) inp.click(); }); },0);
    });
    await scanner.start();
    $("#btnStopCam").disabled = false;
  }

  async function stopScanner(){
    if(!scanner) return;
    await scanner.stop();
    $("#btnStopCam").disabled = true;
  }

  (async ()=>{
    await guard();
    applyLang();
    // Start camera on user click (required on some mobile browsers)
  })();
</script>
</body>
</html>



