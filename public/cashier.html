<!doctype html>
<html lang="ar" dir="rtl">
<head>`n<meta charset="UTF-8">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VIP â€” ظ„ظˆط­ط© ط§ظ„ظ…ط­ط§ط³ط¨</title>
  <link rel="stylesheet" href="/css/styles.css"/>
  <!-- ط¨ط¯ظˆظ† ظ…ظƒطھط¨ط§طھ ط®ط§ط±ط¬ظٹط©: ط§ظ„ظ…ط³ط­ ط¹ط¨ط± BarcodeDetector ط¯ط§ط®ظ„ common.js -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="card">
    <div class="topbar">
      <div class="lang">
        <span class="pill">ظ…ط­ط§ط³ط¨</span>
      </div>
      <div class="lang">
        <button class="pill" id="btnLang">EN</button>
        <a class="pill" href="#" id="btnLogout">ط®ط±ظˆط¬</a>
      </div>
    </div>

    <div class="section">
      <div class="page-title" style="padding:0 0 10px">
        <h2 id="t1">ظ‚ط§ط±ط¦ ط§ظ„ط¨ط§ط±ظƒظˆط¯</h2>
        <p id="t2">ط§ظ…ط³ط­ QR ط£ظˆ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ (ط¬ظˆط§ظ„ + ظ„ظˆط­ط©).</p>
      </div>

      <div id="notice" class="notice" style="display:none"></div>

      <div class="row2">
        <div class="kpi" style="padding:10px">
          <div id="reader" style="width:100%"></div>
          <div class="row2" style="margin-top:10px">
            <button class="btn btn-primary" id="btnCam" type="button">طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§</button>
            <button class="btn btn-ghost" id="btnStopCam" type="button" disabled>ط¥ظٹظ‚ط§ظپ</button>
            <button class="btn btn-ghost" id="btnScanImage" type="button">ط§ظ„طھظ‚ط§ط·/ظ…ط³ط­ طµظˆط±ط©</button>
            <input id="scanImageInput" type="file" accept="image/*" capture="environment" style="display:none" />
          </div>
          <div class="small" style="margin-top:8px" id="t3">ط¥ط°ط§ ظ„ظ… طھط¹ظ…ظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§طŒ ط§ظ…ظ†ط­ ط¥ط°ظ† ط§ظ„ظƒط§ظ…ظٹط±ط§ ط£ظˆ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ.</div>
        </div>

        <div class="kpi" style="padding:10px">
          <div class="field">
            <label id="lPhone">ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„</label>
            <input id="mPhone" inputmode="tel" placeholder="05xxxxxxxx"/>
          </div>
          <div class="field" style="margin-top:8px">
            <label id="lPlate">ط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط©</label>
            <input id="mPlate" class="mono" placeholder="1234"/>
          </div>
          <button class="btn btn-ghost" id="btnManual" style="margin-top:10px">ط¨ط­ط« ظٹط¯ظˆظٹ</button>
        </div>
      </div>
    </div>

    <div class="section" id="resultBox" style="display:none">
      <div class="page-title" style="padding:0 0 10px">
        <h2 id="tRes">ظ†طھظٹط¬ط© ط§ظ„ط¨ط­ط«</h2>
      </div>

      <div class="kpi">
        <div class="label" id="lCust">ط§ظ„ط¹ظ…ظٹظ„</div>
        <div class="value" id="custName" style="font-size:16px">â€”</div>
        <div class="small" id="custMeta"></div>
        <div class="small" style="margin-top:8px">ط§ظ„طھظ‚ظٹظٹظ…: <span id="visitRatingStars" class="stars-inline">â€”</span></div>
      </div>

      <div class="row2" style="margin-top:10px">
        <div class="kpi">
          <div class="label" id="lVisits">ط¹ط¯ط¯ ط§ظ„ط²ظٹط§ط±ط§طھ (ظ…ط¹طھظ…ط¯ط©)</div>
          <div class="value" id="visitsCount">â€”</div>
        </div>
        <div class="kpi">
          <div class="label" id="lPoints">ط§ظ„ظ†ظ‚ط§ط· ط§ظ„ط­ط§ظ„ظٹط©</div>
          <div class="value" id="pointsNow">â€”</div>
          <div class="small" id="pointsMeta"></div>
        </div>
      </div>

      <div class="row2" style="margin-top:10px">
        <button class="btn btn-primary" id="btnApprove">ط§ط¹طھظ…ط§ط¯ ط²ظٹط§ط±ط©</button>
        <button class="btn btn-ghost" id="btnRedeem">ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·</button>
      </div>
    </div>

  </div>
</div>
  <script src="/vendor/html5-qrcode.min.js"></script>
  <script src="/js/common.js"></script>
<script>
  let lastVisit = null;
  let scanner = null;
  let lang = "ar";

function showActionStatus(msg, type=""){
  const el = document.querySelector("#actionStatus");
  if(!el) return;
  el.textContent = msg;
  el.className = "notice " + type;
  el.style.display = "block";
}

  const dict = {
    ar: {
      btnManual:"ط¨ط­ط« ظٹط¯ظˆظٹ",
      approve:"ط§ط¹طھظ…ط§ط¯ ط²ظٹط§ط±ط©",
      redeem:"ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·",
      logout:"ط®ط±ظˆط¬",
      t1:"ظ‚ط§ط±ط¦ ط§ظ„ط¨ط§ط±ظƒظˆط¯",
      t2:"ط§ظ…ط³ط­ QR ط£ظˆ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ (ط¬ظˆط§ظ„ + ظ„ظˆط­ط©).",
      t3:"ط¥ط°ط§ ظ„ظ… طھط¹ظ…ظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§طŒ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ.",
      lPhone:"ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„",
      lPlate:"ط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط©",
      tRes:"ظ†طھظٹط¬ط© ط§ظ„ط¨ط­ط«",
      lCust:"ط§ظ„ط¹ظ…ظٹظ„",
      lVisits:"ط¹ط¯ط¯ ط§ظ„ط²ظٹط§ط±ط§طھ (ظ…ط¹طھظ…ط¯ط©)",
      lPoints:"ط§ظ„ظ†ظ‚ط§ط· ط§ظ„ط­ط§ظ„ظٹط©",
      msgFound:"طھظ… ط¬ظ„ط¨ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط²ظٹط§ط±ط©.",
      msgBad:"QR ط؛ظٹط± طµط§ظ„ط­ ط£ظˆ ظ…ظ†طھظ‡ظٹ.",
      msgNeed:"ط§ظƒطھط¨ ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„ ظˆط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط©.",
      msgNF:"ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط¨ظٹط§ظ†ط§طھ.",
      msgApp:"طھظ… ط§ط¹طھظ…ط§ط¯ ط§ظ„ط²ظٹط§ط±ط©.",
      msgRedeemOk:"طھظ… ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·.",
      msgRedeemNo:(cur,need)=>`ظ„ط§ ظٹظ…ظƒظ† ط§ظ„ط§ط³طھط¨ط¯ط§ظ„. ظ†ظ‚ط§ط· ط§ظ„ط¹ظ…ظٹظ„ ${cur}/${need}`
    },
    en: {
      btnManual:"Manual lookup",
      approve:"Approve visit",
      redeem:"Redeem points",
      logout:"Logout",
      t1:"QR Scanner",
      t2:"Scan QR or use manual (phone + plate).",
      t3:"If camera fails, use manual.",
      lPhone:"Phone",
      lPlate:"Plate numbers",
      tRes:"Result",
      lCust:"Customer",
      lVisits:"Approved visits",
      lPoints:"Current points",
      msgFound:"Visit loaded.",
      msgBad:"Invalid/expired QR.",
      msgNeed:"Enter phone and plate.",
      msgNF:"Not found.",
      msgApp:"Visit approved.",
      msgRedeemOk:"Redeemed.",
      msgRedeemNo:(cur,need)=>`Not enough points: ${cur}/${need}`
    }
  };

  function t(){ return dict[lang]; }
  function applyLang(){
    $("#btnLang").textContent = (lang==="ar") ? "EN" : "AR";
    $("#btnManual").textContent = t().btnManual;
    $("#btnApprove").textContent = t().approve;
    $("#btnRedeem").textContent = t().redeem;
    $("#btnLogout").textContent = t().logout;
    $("#t1").textContent = t().t1;
    $("#t2").textContent = t().t2;
    $("#t3").textContent = t().t3;
    $("#lPhone").textContent = t().lPhone;
    $("#lPlate").textContent = t().lPlate;
    $("#tRes").textContent = t().tRes;
    $("#lCust").textContent = t().lCust;
    $("#lVisits").textContent = t().lVisits;
    $("#lPoints").textContent = t().lPoints;
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang==="ar") ? "rtl" : "ltr";
  }

  async function guard(){
    const me = await api("/api/auth/me");
    if(!me.user || !["admin","cashier"].includes(me.user.role)) location.href="/admin-login.html";
    if(me.user.role==="admin") {
      // admin can still use cashier page; ok
    }
  }

  $("#btnLogout").addEventListener("click", async (e)=>{ e.preventDefault(); await api("/api/auth/logout","POST",{}); location.href="/"; });
  $("#btnLang").addEventListener("click", ()=>{ lang = (lang==="ar") ? "en" : "ar"; applyLang(); });

  $("#btnManual").addEventListener("click", async (e)=>{
    e.preventDefault();
    await lookupManual();
  });

  // Camera must be started by a user gesture on many mobile browsers
  $("#btnCam").addEventListener("click", async ()=>{ await startScanner(); });
  $("#btnStopCam").addEventListener("click", async ()=>{ await stopScanner(); });

  // Scan from an image (works even if camera is blocked)
  $("#btnScanImage").addEventListener("click", ()=>{
    const inp = $("#scanImageInput");
    if(inp) inp.click();
  });
  $("#scanImageInput").addEventListener("change", async (e)=>{
    const file = e.target.files && e.target.files[0];
    if(!file) return;
    hideNotice();
    try{
      let decoded = null;

      if(window.Html5Qrcode){
        const tmpId = 'qr_img_' + Math.random().toString(16).slice(2);
        const tmp = document.createElement('div');
        tmp.id = tmpId;
        tmp.style.display = 'none';
        document.body.appendChild(tmp);
        const h = new Html5Qrcode(tmpId);
        try{
          decoded = await h.scanFile(file, true);
        } finally {
          try{ h.clear(); }catch(_e){}
          try{ tmp.remove(); }catch(_e){}
        }
      } else if('BarcodeDetector' in window){
        const img = await createImageBitmap(file);
        const det = new BarcodeDetector({formats:['qr_code']});
        const codes = await det.detect(img);
        decoded = (codes && codes[0] && codes[0].rawValue) ? codes[0].rawValue : null;
      } else {
        throw new Error('NO_SUPPORT');
      }

      if(!decoded) throw new Error('NO_CODE');
      playBeep();
      const r = await api('/api/visit/lookup','POST',{ qrText: decoded });
      if(r.ok){ applyLookup(r); showNotice(t().msgFound,'good'); }
      else{ showNotice(t().msgBad,'bad'); }
    }catch(err){
      const msg = (err && err.message === 'NO_SUPPORT')
        ? ((lang==='ar')?'ظ‡ط°ط§ ط§ظ„ظ…طھطµظپط­ ظ„ط§ ظٹط¯ط¹ظ… ظ…ط³ط­ QR ظ…ظ† طµظˆط±ط©.':'Browser does not support scan-from-image.')
        : ((lang==='ar')?'طھط¹ط°ط± ظ…ط³ط­ ط§ظ„طµظˆط±ط©.':'Failed to scan image.');
      showNotice(msg,'bad');
    } finally {
      e.target.value = '';
    }
  });

  $("#btnApprove").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/approve","POST",{ visitId: lastVisit.id });
    showNotice(t().msgApp + ` â€” ظ†ظ‚ط§ط·ظƒ ط§ظ„ط¢ظ† ${r.points.current_points}/50`, "good");
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} â€” Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
    // ط¨ط¹ط¯ ط§ظ„ط§ط¹طھظ…ط§ط¯ ظ†ط®ظپظٹ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¹ظ…ظٹظ„ ظˆطھط¸ظ‡ط± ط±ط³ط§ظ„ط© ظپظ‚ط·
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  $("#btnRedeem").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/redeem","POST",{ customerId: lastVisit.customer_id, visitId: lastVisit.id }).catch(err=>err.data);
    if(!r.ok){
      showActionStatus(t().msgRedeemNo(r.current, r.need), "bad");
      return;
    }
    showNotice(t().msgRedeemOk + ` â€” ظ†ظ‚ط§ط·ظƒ ط§ظ„ط¢ظ† ${r.points.current_points}/50`, "good");
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} â€” Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
    // ط¨ط¹ط¯ ط§ظ„ط§ط³طھط¨ط¯ط§ظ„ ظ†ط®ظپظٹ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¹ظ…ظٹظ„ ظˆطھط¸ظ‡ط± ط±ط³ط§ظ„ط© ظپظ‚ط·
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  async function lookupManual(){
    hideNotice();
    const phone = $("#mPhone").value.trim();
    const plate_numbers = $("#mPlate").value.trim();
    if(!phone || !plate_numbers) return showActionStatus(t().msgNeed, "bad");
    const r = await api("/api/visit/lookup","POST",{ phone, plate_numbers }).catch(err=>err.data);
    if(!r.ok) return showActionStatus(t().msgNF, "bad");
    applyLookup(r);
  }

  async function applyLookup(r){
    lastVisit = r.visit;
    $("#resultBox").style.display="block";
    $("#custName").textContent = r.visit.customer_name;
    $("#custMeta").textContent = `Phone: ${r.visit.customer_phone} â€” Plate: ${r.visit.plate_letters_ar} ${r.visit.plate_numbers}`;
    // rating stars
    const rating = Number(r.visit.rating || 0);
    const stars = Array.from({length:5}).map((_,i)=> i<rating ? "âک…" : "âک†").join("");
    const rsEl = document.querySelector("#visitRatingStars");
    if(rsEl) rsEl.textContent = stars;
    $("#visitsCount").textContent = r.visitsCount;
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `Earned: ${r.points.earned_points} â€” Redeemed: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
  }

  async function refreshRedeemButton(){
    // cashiers can't read admin settings; use a tiny endpoint? reuse /api/admin/settings is admin-only. We'll hardcode by reading public settings is not enough.
    // workaround: redeem is enforced server-side; we disable button only visually using current points threshold 50 default.
    const can = Number($("#pointsNow").textContent || "0") >= 50;
    $("#btnRedeem").disabled = !can;
    $("#btnRedeem").style.opacity = can ? "1" : ".55";
  }

  async function startScanner(){
    hideNotice();
    if(!scanner) scanner = createQrScanner($("#reader"), async (decodedText)=>{
      playBeep();
      const r = await api("/api/visit/lookup","POST",{ qrText: decodedText });
      if(r.ok){
        applyLookup(r);
        showNotice(t().msgFound, "good");
      }else{
        showNotice(t().msgBad, "bad");
      }
    }, (err)=>{
      const isNotSecure = !!(err && (err.code==='NOT_SECURE' || err.name==='NOT_SECURE' || err.message==='NOT_SECURE'));
      const httpsUrl = suggestedHttpsUrl();

      if(isNotSecure){
        if(httpsUrl){
          const msg = (lang==="ar")
            ? `ظ„ظ… ظٹطھظ… طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ„ط£ظ† ط§ظ„طµظپط­ط© ظ„ظٹط³طھ ط¢ظ…ظ†ط© (HTTP). ط³ظٹطھظ… طھط­ظˆظٹظ„ظƒ طھظ„ظ‚ط§ط¦ظٹط§ظ‹ ظ„ظ„ظ†ط³ط®ط© ط§ظ„ط¢ظ…ظ†ط©. ط¥ط°ط§ ظ„ظ… ظٹط­ط¯ط« ط§ظ„طھط­ظˆظٹظ„ ط§ط¶ط؛ط·: <button class="pill" id="openHttpsBtn" type="button">ظپطھط­ ط¹ط¨ط± HTTPS</button>`
            : `Camera requires HTTPS. Redirecting now. If not redirected, click: <button class="pill" id="openHttpsBtn" type="button">Open HTTPS</button>`;
          showNoticeHtml(msg, "bad");
          setTimeout(()=>{
            const b = document.getElementById('openHttpsBtn');
            if(b) b.addEventListener('click', ()=>{ location.href = httpsUrl; });
          }, 0);
        }else{
          showNotice((lang==="ar")
            ? `ظ„ظ… ظٹطھظ… طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ„ط£ظ† ط§ظ„طµظپط­ط© ظ„ظٹط³طھ ط¢ظ…ظ†ط©. ط§ظپطھط­ ط¹ط¨ط± https ط¹ظ„ظ‰ ط§ظ„ظ…ظ†ظپط° 3443 (ظ…ط«ط§ظ„: https://${location.hostname}:3443).`
            : 'Camera requires HTTPS (port 3443).', "bad");
        }
        return;
      }
      // ط¥ط°ط§ ظƒط§ظ† ط§ظ„ظ…طھطµظپط­ ظ„ط§ ظٹط¯ط¹ظ… ظ…ط³ط­ QR ط¨ط§ظ„ظƒط§ظ…ظٹط±ط§
      if(!(window.Html5Qrcode || ("BarcodeDetector" in window))){
        const m = (lang==="ar")
          ? "ظ‡ط°ط§ ط§ظ„ظ…طھطµظپط­ ظ„ط§ ظٹط¯ط¹ظ… ظ…ط³ط­ QR ط¨ط§ظ„ظƒط§ظ…ظٹط±ط§. ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ ط£ظˆ ط§ظپطھط­ ط§ظ„طµظپط­ط© ظپظٹ Chrome/Edge ط­ط¯ظٹط«."
          : "This browser does not support QR scanning. Use manual input or open in a recent Chrome/Edge.";
        showNotice(m, "bad");
        return;
      }
      // ط£ط®ط·ط§ط، طµظ„ط§ط­ظٹط§طھ/ط§ط³طھط®ط¯ط§ظ… ط§ظ„ظƒط§ظ…ظٹط±ط§
      const n = (err && err.name) ? err.name : '';
      const msgAr = (n==='NotAllowedError' || n==='PermissionDeniedError')
        ? 'طھظ… ط±ظپط¶ ط¥ط°ظ† ط§ظ„ظƒط§ظ…ظٹط±ط§. ظ…ظ† ط¥ط¹ط¯ط§ط¯ط§طھ ط§ظ„ظ…طھطµظپط­: Site settings > Camera > Allow ط«ظ… ط­ط¯ظ‘ط« ط§ظ„طµظپط­ط©.'
        : (n==='NotFoundError')
          ? 'ظ„ط§ طھظˆط¬ط¯ ظƒط§ظ…ظٹط±ط§ ظ…طھط§ط­ط© ط¹ظ„ظ‰ ظ‡ط°ط§ ط§ظ„ط¬ظ‡ط§ط².'
          : (n==='NotReadableError')
            ? 'ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ…ط´ط؛ظˆظ„ط© ط¨طھط·ط¨ظٹظ‚ ط¢ط®ط±. ط§ط؛ظ„ظ‚ ط£ظٹ طھط·ط¨ظٹظ‚ ظٹط³طھط®ط¯ظ… ط§ظ„ظƒط§ظ…ظٹط±ط§ ط«ظ… ط¬ط±ظ‘ط¨.'
            : 'طھط¹ط°ط± طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§. ط¬ط±ظ‘ط¨ ظپطھط­ ط§ظ„طµظپط­ط© ظپظٹ Chrome/Edge ظˆط§ط³ظ…ط­ ط¨ط¥ط°ظ† ط§ظ„ظƒط§ظ…ظٹط±ط§.';
      const msgEn = (n==='NotAllowedError' || n==='PermissionDeniedError')
        ? 'Camera permission denied. Allow it in Site Settings then refresh.'
        : (n==='NotFoundError')
          ? 'No camera found on this device.'
          : (n==='NotReadableError')
            ? 'Camera is in use by another app. Close it and retry.'
            : 'Failed to start camera. Try Chrome/Edge and allow permission.';
      const html = ((lang==="ar") ? msgAr : msgEn) + ` â€” <button class="pill" id="useImageScanBtn" type="button">${(lang==="ar")?'ظ…ط³ط­ ظ…ظ† طµظˆط±ط©':'Scan from image'}</button>`;
      showNoticeHtml(html, "bad");
      setTimeout(()=>{ const b=document.getElementById('useImageScanBtn'); if(b) b.addEventListener('click', ()=>{ const inp=document.getElementById('scanImageInput'); if(inp) inp.click(); }); },0);
    });
    await scanner.start();
    $("#btnStopCam").disabled = false;
  }

  async function stopScanner(){
    if(!scanner) return;
    await scanner.stop();
    $("#btnStopCam").disabled = true;
  }

  (async ()=>{
    await guard();
    applyLang();
    // Start camera on user click (required on some mobile browsers)
  })();
</script>
</body>
</html>

