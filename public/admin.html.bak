<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">`n<meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>VIP â€” ظ„ظˆط­ط© ط§ظ„ط£ط¯ظ…ظ†</title>
  <link rel="stylesheet" href="/css/styles.css?v=202601091251"/>
  <!-- ط¨ط¯ظˆظ† ظ…ظƒطھط¨ط§طھ ط®ط§ط±ط¬ظٹط©: ط§ظ„ظ…ط³ط­ ط¹ط¨ط± BarcodeDetector ط¯ط§ط®ظ„ common.js -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
  <div class="card">
    <div class="topbar iconbar">
      <div class="icon-group">
        <button class="icon-btn" id="btnMe" type="button" title="ط£ط¯ظ…ظ†"></button>
      </div>
      <div class="icon-group">
        <button class="icon-btn" id="btnSettings" type="button" title="ط§ظ„ط¥ط¹ط¯ط§ط¯ط§طھ"></button>
        <button class="icon-btn" id="btnNoti" type="button" title="ط§ظ„ط¥ط´ط¹ط§ط±ط§طھ"><span class="badge" id="notiBadge">0</span></button>
        <button class="icon-btn" id="btnExportX" type="button" title="طھطµط¯ظٹط± Excel"></button>
        <button class="icon-btn" id="btnExportW" type="button" title="طھطµط¯ظٹط± Word"></button>
        <button class="icon-btn" id="btnLogout" type="button" title="ط®ط±ظˆط¬"></button>
      </div>
    </div>

    <div class="section grid2">
      <div class="kpi">
        <div class="label">ظ…ط¹ط¯ظ„ طھظ‚ظٹظٹظ… ط§ظ„ط¹ظ…ظ„ط§ط،</div>
        <div class="value" id="avgRating">â€”</div>
      </div>
    </div>

    <div class="section">
      <div class="page-title" style="padding:0 0 10px">
        <h2>ظ‚ط§ط±ط¦ ط§ظ„ط¨ط§ط±ظƒظˆط¯</h2>
        <p>ط§ظ…ط³ط­ QR ط£ظˆ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ (ط¬ظˆط§ظ„ + ظ„ظˆط­ط©).</p>
      </div>

      <div id="notice" class="notice" style="display:none"></div>

      <div class="row2">
        <div class="kpi" style="padding:10px">
          <div id="reader" style="width:100%"></div>
          <div class="row2" style="margin-top:10px">
            <button class="btn btn-primary" id="btnCam" type="button">طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§</button>
            <button class="btn btn-ghost" id="btnStopCam" type="button" disabled>ط¥ظٹظ‚ط§ظپ</button>
            <button class="btn btn-ghost" id="btnScanImage" type="button">ط§ظ„طھظ‚ط§ط·/ظ…ط³ط­ طµظˆط±ط©</button>
            <input id="scanImageInput" type="file" accept="image/*" capture="environment" style="display:none" />
          </div>
          <div class="small" style="margin-top:8px">ط¥ط°ط§ ظ„ظ… طھط¹ظ…ظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§طŒ ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ.</div>
        </div>

        <div class="kpi" style="padding:10px">
          <div class="field">
            <label>ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„</label>
            <input id="mPhone" inputmode="tel" placeholder="05xxxxxxxx"/>
          </div>
          <div class="field" style="margin-top:8px">
            <label>ط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط©</label>
            <input id="mPlate" class="mono" placeholder="1234"/>
          </div>
          <button class="btn btn-ghost" id="btnManual" style="margin-top:10px">ط¨ط­ط« ظٹط¯ظˆظٹ</button>
        </div>
      </div>
    </div>

    <div class="section" id="resultBox" style="display:none">
      <div class="page-title" style="padding:0 0 10px">
        <h2>ظ†طھظٹط¬ط© ط§ظ„ط¨ط­ط«</h2>
      </div>

      <div class="kpi">
        <div class="label">ط§ظ„ط¹ظ…ظٹظ„</div>
        <div class="value" id="custName" style="font-size:16px">â€”</div>
        <div class="small" id="custMeta"></div>
        <div class="small" style="margin-top:8px">ط§ظ„طھظ‚ظٹظٹظ…: <span id="visitRatingStars" class="stars-inline">â€”</span></div>
      </div>

      <div class="row2" style="margin-top:10px">
        <div class="kpi">
          <div class="label">ط¹ط¯ط¯ ط§ظ„ط²ظٹط§ط±ط§طھ (ظ…ط¹طھظ…ط¯ط©)</div>
          <div class="value" id="visitsCount">â€”</div>
        </div>
        <div class="kpi">
          <div class="label">ط§ظ„ظ†ظ‚ط§ط· ط§ظ„ط­ط§ظ„ظٹط©</div>
          <div class="value" id="pointsNow">â€”</div>
          <div class="small" id="pointsMeta"></div>
        </div>
      </div>

      <div class="row2" style="margin-top:10px">
        <button class="btn btn-primary" id="btnApprove">ط§ط¹طھظ…ط§ط¯ ط²ظٹط§ط±ط©</button>
        <button class="btn btn-ghost" id="btnRedeem">ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·</button>
      </div>
    </div>

    <div class="section">
      <div class="page-title" style="padding:0 0 10px">
        <h2>ط؛ط³ظ„ط§طھ ظ„ظƒظ„ ظ…ط­ط§ط³ط¨</h2>
      </div>
      <table class="table" id="cashierTable">
        <thead><tr><th>ط§ظ„ظ…ط­ط§ط³ط¨</th><th>ط¹ط¯ط¯ ط§ظ„ط؛ط³ظ„ط§طھ</th><th>طھظ‚ظٹظٹظ…ظ‡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Stats: placed at the end as requested -->
    <div class="section" id="statsSection" style="margin-top:6px">
      <div class="page-title" style="padding:0 0 10px">
        <h2 id="statsLabel">ط¥ط­طµط§ط¦ظٹط§طھ ط¢ط®ط± 30 ظٹظˆظ…</h2>
        <p>ظ…ط¬ظ…ظˆط¹ط© ظپظٹ ظ…ط±ط¨ط¹ ظˆط§ط­ط¯ â€” ط§ط¶ط؛ط· ط£ظٹ ط¨ط·ط§ظ‚ط© ظ„ظ„طھظپط§طµظٹظ„.</p>
      </div>

      <div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
        <button class="kpi stat-tile" id="openStatsCashiers" type="button" style="text-align:right">
          <div class="label">ظ…ط³ط§ظ‡ظ…ط© ط§ظ„ظ…ط­ط§ط³ط¨ظٹظ†</div>
          <div class="small">ظ†ظگط³ظژط¨ ط§ظ„ط؛ط³ظ„ط§طھ + ط§ظ„طھظ‚ظٹظٹظ…</div>
        </button>
        <button class="kpi stat-tile" id="openStatsVisits" type="button" style="text-align:right">
          <div class="label">ط§ظ„ط²ظٹط§ط±ط§طھ / ط§ظ„ط§ط³طھط¨ط¯ط§ظ„</div>
          <div class="small">ظ…ظ‚ط§ط±ظ†ط© ط¥ط¶ط§ظپط© ظ…ظ‚ط§ط¨ظ„ ط§ط³طھط¨ط¯ط§ظ„</div>
        </button>
        <button class="kpi stat-tile" id="openStatsRatings" type="button" style="text-align:right">
          <div class="label">طھظˆط²ظٹط¹ ط§ظ„طھظ‚ظٹظٹظ…ط§طھ</div>
          <div class="small">1âک… ط¥ظ„ظ‰ 5âک…</div>
        </button>
      </div>
    </div>

  </div>
</div>

<!-- Stats Modal -->
<div class="modal-backdrop" id="statsBack" onclick="if(event.target.id==='statsBack') closeStats()" style="display:none">
  <div class="modal">
    <h3 id="statsModalTitle">ط§ظ„ط¥ط­طµط§ط¦ظٹط§طھ</h3>
    <div class="small" id="statsModalSub" style="margin-top:-6px">â€”</div>
    <div class="kpi" style="margin-top:10px">
      <canvas id="statsChart" height="220"></canvas>
    </div>
    <div class="kpi" style="margin-top:10px">
      <div class="label">طھظپط§طµظٹظ„</div>
      <div id="statsDetails" class="small" style="white-space:pre-line"></div>
    </div>
    <div class="row2" style="margin-top:12px">
      <button class="btn btn-ghost" type="button" onclick="closeStats()">ط¥ط؛ظ„ط§ظ‚</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-backdrop" id="settingsBack" onclick="if(event.target.id==='settingsBack') closeSettings()">
  <div class="modal">
    <h3>ط§ظ„ط¥ط¹ط¯ط§ط¯ط§طھ</h3>
    <div id="settingsNotice" class="notice" style="display:none"></div>
    <form class="form" id="settingsForm" style="padding:0">
      <div class="field">
        <label>ظ†طµ ط§ظ„طµظپط­ط© ط§ظ„ط±ط¦ظٹط³ظٹط© 1</label>
        <input name="home_text_1"/>
      </div>
      <div class="field">
        <label>ظ†طµ ط§ظ„طµظپط­ط© ط§ظ„ط±ط¦ظٹط³ظٹط© 2</label>
        <input name="home_text_2"/>
      </div>

      <div class="field">
        <label>ط§ظ„ط´ط±ظˆط· ظˆط§ظ„ط£ط­ظƒط§ظ… (طھط¸ظ‡ط± ظ„ظ„ط¹ظ…ظٹظ„ ظپظٹ ط§ظ„ط±ط¦ظٹط³ظٹط©)</label>
        <textarea name="terms_text" placeholder="ط§ظƒطھط¨ ط§ظ„ط´ط±ظˆط· ظ‡ظ†ط§..."></textarea>
      </div>
      <div class="row2">
        <div class="field">
          <label>ط­ط¯ ط¥ط¶ط§ظپط© ط§ظ„ظ†ظ‚ط§ط· (ظ„ظ„ط¥ط¸ظ‡ط§ط±)</label>
          <input name="points_add_limit" inputmode="numeric"/>
        </div>
        <div class="field">
          <label>ط­ط¯ ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·</label>
          <input name="points_redeem_limit" inputmode="numeric"/>
        </div>
      </div>
      <div class="field">
        <label>ظ†ظ‚ط§ط· ظ„ظƒظ„ ط²ظٹط§ط±ط© (ط§ط¹طھظ…ط§ط¯)</label>
        <input name="points_per_visit" inputmode="numeric"/>
      </div>
      <div class="row2">
        <div class="field">
          <label>ط±ط§ط¨ط· ظˆط§طھط³ط§ط¨</label>
          <input name="social_whatsapp"/>
        </div>
        <div class="field">
          <label>ط±ط§ط¨ط· ط³ظ†ط§ط¨</label>
          <input name="social_snap"/>
        </div>
      </div>
      <div class="field">
        <label>ط±ط§ط¨ط· طھظٹظƒ طھظˆظƒ</label>
        <input name="social_tiktok"/>
      </div>
      <div class="field">
        <label>ط±ط§ط¨ط· ظ‚ظˆظ‚ظ„ ظ…ط§ط¨</label>
        <input name="social_maps" placeholder="https://maps.google.com/..."/>
      </div>

      <div class="field">
        <label>ظ†طµ ظ†ط§ظپط°ط© ظ…ط§ ط¨ط¹ط¯ ط§ظ„ط§ط¹طھظ…ط§ط¯ (ظٹط¸ظ‡ط± ط¨ط¹ط¯ ط§ط¹طھظ…ط§ط¯ ط§ظ„ظ…ط­ط§ط³ط¨)</label>
        <input name="after_approve_text" placeholder="ظ…ط«ظ„: طھط§ط¨ط¹ظ†ط§..."/>
      </div>
      <button class="btn btn-primary" type="submit">ط­ظپط¸</button>
      <button class="btn btn-ghost" type="button" onclick="closeSettings()">ط¥ط؛ظ„ط§ظ‚</button>
    </form>

    <hr style="border-color:rgba(255,255,255,.12);margin:14px 0"/>

    <h3>ط¥ط¯ط§ط±ط© ط§ظ„ظ…ط³طھط®ط¯ظ…ظٹظ†</h3>
    <div class="small">ط¥ط¶ط§ظپط©/طھط¹ط¯ظٹظ„/ط­ط°ظپ (ط£ط¯ظ…ظ†/ظ…ط­ط§ط³ط¨)</div>
    <div class="notice" id="usersNotice" style="display:none"></div>

    <form class="form" id="addUserForm" style="padding:0;margin-top:10px">
      <div class="row2">
        <div class="field">
          <label>ط§ط³ظ… ط§ظ„ظ…ط³طھط®ط¯ظ… (ظ„ظ„ط¯ط®ظˆظ„)</label>
          <input name="username" required/>
        </div>
        <div class="field">
          <label>ط§ط³ظ… ط§ظ„ظ…ط­ط§ط³ط¨ (ظٹط¸ظ‡ط± ط¨ط§ظ„طھظ‚ظٹظٹظ…ط§طھ)</label>
          <input name="display_name" required/>
        </div>
      </div>
      <div class="row2">
        <div class="field">
          <label>ظƒظ„ظ…ط© ط§ظ„ط³ط±</label>
          <input name="password" type="password" required autocomplete="new-password"/>
        </div>
        <div class="field">
          <label>ط§ظ„طµظ„ط§ط­ظٹط©</label>
          <select name="role" required>
            <option value="cashier">ظ…ط­ط§ط³ط¨</option>
            <option value="admin">ط£ط¯ظ…ظ†</option>
          </select>
        </div>
      </div>
      <button class="btn btn-ghost" type="submit">ط¥ط¶ط§ظپط© ظ…ط³طھط®ط¯ظ…</button>
    </form>

    <div class="section" style="padding:0;margin-top:10px">
      <table class="table" id="usersTable">
        <thead><tr><th>ط§ظ„ظ…ط³طھط®ط¯ظ…</th><th>ط§ظ„ط¯ظˆط±</th><th>ظ†ط´ط·</th><th>ط¥ط¬ط±ط§ط،</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<!-- Notifications Modal -->
<div class="modal-backdrop" id="notiBack" onclick="if(event.target.id==='notiBack') closeNoti()">
  <div class="modal">
    <h3>ط§ظ„ط¥ط´ط¹ط§ط±ط§طھ</h3>
    <div class="small">ط¢ط®ط± 50 ط¥ط´ط¹ط§ط±</div>
    <div class="kpi" id="notiDetail" style="display:none;margin-top:10px">
      <div class="label">طھظپط§طµظٹظ„ ط§ظ„ط¥ط´ط¹ط§ط±</div>
      <div class="value" id="notiCust" style="font-size:16px">â€”</div>
      <div class="small" id="notiMeta"></div>
      <div class="small" style="margin-top:10px">ط§ظ„ط²ظٹط§ط±ط§طھ:</div>
      <div class="small mono" id="notiVisits" style="white-space:pre-wrap; line-height:1.7"></div>
    </div>
    <div class="section" style="padding:0;margin-top:10px">
      <table class="table" id="notiTable">
        <thead><tr><th>ط§ظ„ط¹ظ…ظٹظ„</th><th>ط§ظ„ط±ط³ط§ظ„ط©</th><th>ط§ظ„ظˆظ‚طھ</th><th>ظ…ظ‚ط±ظˆط،</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
      <button class="btn btn-ghost" type="button" id="clearNotiBtn">ظ…ط³ط­ ط§ظ„ط¥ط´ط¹ط§ط±ط§طھ</button>
      <button class="btn btn-ghost" type="button" onclick="closeNoti()">ط¥ط؛ظ„ط§ظ‚</button>
    </div>
  </div>
</div>
  <script src="/vendor/chart.umd.js?v=202601091251"></script>
  <script src="/vendor/html5-qrcode.min.js?v=202601091251"></script>
  <script src="/js/common.js?v=202601091251"></script>
<script>
  let lastVisit = null;
  let scanner = null;

  async function guard(){
    const me = await api("/api/auth/me");
    if(!me.user || me.user.role !== "admin") location.href="/admin-login.html";
  }

  function openSettings(){ $("#settingsBack").style.display="grid"; }
  function closeSettings(){ $("#settingsBack").style.display="none"; }
  function openNoti(){ $("#notiBack").style.display="grid"; }
  function closeNoti(){ $("#notiBack").style.display="none"; }

  function showToast(msg){
    const n = document.getElementById("notiNotice") || document.getElementById("notice");
    if(n){
      n.style.display="block";
      n.className="notice good";
      n.textContent = msg;
      setTimeout(()=>{n.style.display="none";}, 1800);
      return;
    }
    alert(msg);
  }

  // ط£ظٹظ‚ظˆظ†ط§طھ ط§ظ„ط´ط±ظٹط· ط§ظ„ط¹ظ„ظˆظٹ
  $("#btnMe").innerHTML = iconAdmin();
  $("#btnSettings").innerHTML = iconSettings();
  $("#btnNoti").innerHTML = iconBell() + '<span class="badge" id="notiBadge">0</span>';
  $("#btnExportX").innerHTML = iconExcel();
  $("#btnExportW").innerHTML = iconWord();
  $("#btnLogout").innerHTML = iconLogout();

  $("#btnLogout").addEventListener("click", async ()=>{ await api("/api/auth/logout","POST",{}); location.href="/"; });
  $("#btnSettings").addEventListener("click", async ()=>{ await loadSettings(); await loadUsers(); openSettings(); });
  $("#btnNoti").addEventListener("click", async ()=>{ openNoti(); await loadNoti().catch(()=>{}); });

  $("#btnExportX").addEventListener("click",()=>{ window.open("/api/admin/export/excel","_blank"); });
  $("#btnExportW").addEventListener("click",()=>{ window.open("/api/admin/export/word","_blank"); });

  $("#btnManual").addEventListener("click", async (e)=>{
    e.preventDefault();
    await lookupManual();
  });

  $("#btnApprove").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/approve","POST",{ visitId: lastVisit.id });
    showNotice(`طھظ… ط¥ط¶ط§ظپط© ط§ظ„ظ†ظ‚ط§ط·. ظ†ظ‚ط§ط· ط§ظ„ط¹ظ…ظٹظ„ ط§ظ„ط¢ظ† ${r.points.current_points}/${(await api("/api/admin/settings")).settings.points_add_limit}`, "good");
    // ط¨ط¹ط¯ ط§ظ„ط§ط¹طھظ…ط§ط¯ ظ†ط®ظپظٹ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¹ظ…ظٹظ„ ط­ط³ط¨ ط§ظ„ظ…ط·ظ„ظˆط¨
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  $("#btnRedeem").addEventListener("click", async ()=>{
    if(!lastVisit) return;
    const r = await api("/api/visit/redeem","POST",{ customerId: lastVisit.customer_id, visitId: lastVisit.id }).catch(err=>err.data);
    if(!r.ok){
      showNotice(`ظ„ط§ ظٹظ…ظƒظ† ط§ظ„ط§ط³طھط¨ط¯ط§ظ„. ظ†ظ‚ط§ط· ط§ظ„ط¹ظ…ظٹظ„ ${r.current}/${r.need}`, "bad");
      return;
    }
    showNotice(`طھظ… ط§ط³طھط¨ط¯ط§ظ„ ط§ظ„ظ†ظ‚ط§ط·. ط§ظ„ظ†ظ‚ط§ط· ط§ظ„ط¢ظ† ${r.points.current_points}`, "good");
    $("#resultBox").style.display = "none";
    lastVisit = null;
  });

  $("#settingsForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.target).entries());
    const r = await api("/api/admin/settings","POST",body);
    $("#settingsNotice").style.display="block";
    $("#settingsNotice").className="notice good";
    $("#settingsNotice").textContent="طھظ… ط­ظپط¸ ط§ظ„ط¥ط¹ط¯ط§ط¯ط§طھ.";
  });

  $("#addUserForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const body = Object.fromEntries(new FormData(e.target).entries());
    const r = await api("/api/admin/users/add","POST",body).catch(err=>err.data);
    if(!r.ok){
      $("#usersNotice").style.display="block";
      $("#usersNotice").className="notice bad";
      $("#usersNotice").textContent="طھط¹ط°ط± ط§ظ„ط¥ط¶ط§ظپط© (ظ‚ط¯ ظٹظƒظˆظ† ط§ط³ظ… ط§ظ„ظ…ط³طھط®ط¯ظ… ظ…ظˆط¬ظˆط¯).";
      return;
    }
    e.target.reset();
    await loadUsers();
  });

  async function loadSettings(){
    const r = await api("/api/admin/settings");
    const f = $("#settingsForm");
    f.home_text_1.value = r.settings.home_text_1 || "";
    f.home_text_2.value = r.settings.home_text_2 || "";
    if(f.terms_text) f.terms_text.value = r.settings.terms_text || "";
    f.points_add_limit.value = r.settings.points_add_limit || 50;
    f.points_redeem_limit.value = r.settings.points_redeem_limit || 50;
    f.points_per_visit.value = r.settings.points_per_visit || 10;
    f.social_whatsapp.value = r.settings.social_whatsapp || "";
    f.social_snap.value = r.settings.social_snap || "";
    f.social_tiktok.value = r.settings.social_tiktok || "";
    f.social_maps.value = r.settings.social_maps || "";
    f.after_approve_text.value = r.settings.after_approve_text || "";
    $("#settingsNotice").style.display="none";
  }

  async function loadUsers(){
    const r = await api("/api/admin/users");
    const tbody = $("#usersTable tbody");
    tbody.innerHTML="";
    r.users.forEach(u=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.role === "admin" ? "ط£ط¯ظ…ظ†" : "ظ…ط­ط§ط³ط¨"}</td>
        <td>${u.is_active ? "ظ†ط¹ظ…" : "ظ„ط§"}</td>
        <td>
          <button class="pill" data-act="toggle" data-id="${u.id}" data-active="${u.is_active}">${u.is_active ? "طھط¹ط·ظٹظ„" : "طھظپط¹ظٹظ„"}</button>
          <button class="pill" data-act="reset" data-id="${u.id}">طھط؛ظٹظٹط± ظƒظ„ظ…ط©</button>
          <button class="pill" data-act="del" data-id="${u.id}">ط­ط°ظپ</button>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const id = b.dataset.id;
        const act = b.dataset.act;
        if(act==="toggle"){
          await api("/api/admin/users/update","POST",{ id, is_active: b.dataset.active !== "1" });
          await loadUsers();
        }else if(act==="reset"){
          const p = prompt("ط§ظƒطھط¨ ظƒظ„ظ…ط© ط§ظ„ط³ط± ط§ظ„ط¬ط¯ظٹط¯ط©:");
          if(!p) return;
          await api("/api/admin/users/update","POST",{ id, password: p });
          alert("طھظ… طھط؛ظٹظٹط± ظƒظ„ظ…ط© ط§ظ„ط³ط±.");
        }else if(act==="del"){
          if(!confirm("ط­ط°ظپ ط§ظ„ظ…ط³طھط®ط¯ظ…طں")) return;
          await api("/api/admin/users/delete","POST",{ id });
          await loadUsers();
        }
      });
    });
  }

  async function loadNoti(){
    const r = await api("/api/admin/notifications").catch(()=>({ ok:false }));
    const tbody = $("#notiTable tbody");
    if(!tbody) return;

    tbody.innerHTML = "";

    const list = (r && r.ok && Array.isArray(r.notifications)) ? r.notifications : [];

    if(!r || !r.ok){
      // ظ„ط§ ظ†ظƒط³ط± ط§ظ„ظˆط§ط¬ظ‡ط© ط¥ط°ط§ ظپط´ظ„ ط§ظ„ط¬ظ„ط¨
      showNotice("طھط¹ط°ط± طھط­ظ…ظٹظ„ ط§ظ„ط¥ط´ط¹ط§ط±ط§طھ. طھط£ظƒط¯ ط£ظ†ظƒ ظ…ط³ط¬ظ„ ط¯ط®ظˆظ„ ظƒط£ط¯ظ…ظ†.", "bad");
    }

    if(list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" style="text-align:center;opacity:.7">ظ„ط§ طھظˆط¬ط¯ ط¥ط´ط¹ط§ط±ط§طھ</td>`;
      tbody.appendChild(tr);
      await updateNotiBadge().catch(()=>{});
      return;
    }

    list.forEach(n=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><button class='pill' data-act='show' data-id='${n.id}'>${n.customer_name} â€” ${n.customer_phone}</button></td>
        <td>${n.message}</td>
        <td class="mono">${(n.created_at||'').slice(0,19).replace("T"," ")}</td>
        <td>${n.is_read ? "ظ†ط¹ظ…" : "<button class='pill' data-id='"+n.id+"'>طھظ…ظٹظٹط² ظƒظ…ظ‚ط±ظˆط،</button>"}</td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.dataset.act;
        if(act === "show"){
          await showNotiDetail(btn.dataset.id);
          return;
        }
        const rr = await api("/api/admin/notifications/mark-read","POST",{ id: btn.dataset.id }).catch(()=>({ok:false}));
        if(!rr.ok){
          showNotice("طھط¹ط°ط± طھط­ط¯ظٹط« ط§ظ„ط¥ط´ط¹ط§ط±.", "bad");
          return;
        }
        await updateNotiBadge().catch(()=>{});
        await loadNoti().catch(()=>{});
      });
    });

    await updateNotiBadge().catch(()=>{});
  }


  async function updateNotiBadge(){
    const r = await api("/api/admin/notifications/unread-count").catch(()=>({ ok:false }));
    if(!r || !r.ok) return;
    const n = Number(r.count||0);
    const b = document.querySelector("#notiBadge");
    if(!b) return;
    b.textContent = n>99 ? "99+" : String(n);
    b.style.display = n>0 ? "inline-flex" : "none";
  }


  async function showNotiDetail(id){
    const r = await api("/api/admin/notifications/detail?id=" + encodeURIComponent(id)).catch(err=>err.data);
    if(!r || !r.ok) {
      showNotice("طھط¹ط°ط± ط¬ظ„ط¨ ط§ظ„طھظپط§طµظٹظ„.", "bad");
      return;
    }
    $("#notiDetail").style.display = "block";
    $("#notiCust").textContent = `${r.customer.name} â€” ${r.customer.phone}`;
    $("#notiMeta").textContent = r.notification.message;

    const rows = (r.visits||[]).map(v=>{
      const dt = (v.created_at||"").slice(0,19).replace("T"," ");
      const cashier = v.cashier_name || v.cashier_username || "â€”";
      const plate = `${v.plate_letters_ar} ${v.plate_numbers}`.trim();
      const stars = Array.from({length:5}).map((_,i)=> i < Number(v.rating||0) ? "âک…" : "âک†").join("");
      return `<tr><td class="mono">${dt}</td><td>${plate}</td><td style="font-size:14px">${stars}</td><td>${cashier}</td></tr>`;
    }).join("");

    const table = `
      <table class="tmini">
        <thead>
          <tr><th>ط§ظ„طھط§ط±ظٹط®</th><th>ط§ظ„ظ„ظˆط­ط©</th><th>ط§ظ„طھظ‚ظٹظٹظ…</th><th>ط§ظ„ظ…ط­ط§ط³ط¨</th></tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="4" style="text-align:center;opacity:.7">ظ„ط§ طھظˆط¬ط¯ ط²ظٹط§ط±ط§طھ</td></tr>`}</tbody>
      </table>
    `;
    const box = $("#notiVisits");
    box.innerHTML = table;
  }

  async function lookupManual(){
    hideNotice();
    const phone = $("#mPhone").value.trim();
    const plate_numbers = $("#mPlate").value.trim();
    if(!phone || !plate_numbers) return showNotice("ط§ظƒطھط¨ ط±ظ‚ظ… ط§ظ„ط¬ظˆط§ظ„ ظˆط£ط±ظ‚ط§ظ… ط§ظ„ظ„ظˆط­ط©.", "bad");
    const r = await api("/api/visit/lookup","POST",{ phone, plate_numbers }).catch(err=>err.data);
    if(!r.ok) return showNotice("ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط¨ظٹط§ظ†ط§طھ.", "bad");
    applyLookup(r);
  }

  async function applyLookup(r){
    lastVisit = r.visit;
    $("#resultBox").style.display="block";
    $("#custName").textContent = r.visit.customer_name;
    $("#custMeta").textContent = `ط¬ظˆط§ظ„: ${r.visit.customer_phone} â€” ظ„ظˆط­ط©: ${r.visit.plate_letters_ar} ${r.visit.plate_numbers}`;
    // rating stars
    const rating = Number(r.visit.rating || 0);
    const stars = Array.from({length:5}).map((_,i)=> i<rating ? "âک…" : "âک†").join("");
    const rsEl = document.querySelector("#visitRatingStars");
    if(rsEl) rsEl.textContent = stars;
    $("#visitsCount").textContent = r.visitsCount;
    $("#pointsNow").textContent = r.points.current_points;
    $("#pointsMeta").textContent = `ظ…ظƒطھط³ط¨ط©: ${r.points.earned_points} â€” ظ…ط³طھط¨ط¯ظ„ط©: ${r.points.redeemed_points}`;
    await refreshRedeemButton();
  }

  async function refreshRedeemButton(){
    const s = await api("/api/admin/settings");
    const can = Number($("#pointsNow").textContent || "0") >= Number(s.settings.points_redeem_limit || 50);
    $("#btnRedeem").disabled = !can;
    $("#btnRedeem").style.opacity = can ? "1" : ".55";
  }

  async function loadDashboard(){
    const r = await api("/api/admin/dashboard");
    $("#avgRating").textContent = (Number(r.avgRating || 0)).toFixed(2);
    const tbody = $("#cashierTable tbody");
    tbody.innerHTML="";
    r.cashiers.forEach(c=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${c.cashier || "â€”"}</td><td>${c.washes}</td><td>${(Number(c.avgRating||0)).toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function startScanner(){
    hideNotice();
    if(!scanner) scanner = createQrScanner($("#reader"), async (decodedText)=>{
      playScanBeep();
      const r = await api("/api/visit/lookup","POST",{ qrText: decodedText }).catch(err=>err.data);
      if(r.ok){
        applyLookup(r);
        showNotice("طھظ… ط¬ظ„ط¨ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط²ظٹط§ط±ط©.", "good");
      }else{
        showNotice("QR ط؛ظٹط± طµط§ظ„ط­ ط£ظˆ ظ…ظ†طھظ‡ظٹ.", "bad");
      }
    }, (err)=>{
      // ط¥ط°ط§ ظ„ظ… طھظڈط­ظ…ظ‘ظ„ ظ…ظƒطھط¨ط© ط§ظ„ظ…ط³ط­ (ط£ظˆ ظ„ظ… ظٹط¯ط¹ظ… ط§ظ„ظ…طھطµظپط­)طŒ ظˆط¶ظ‘ط­ ط§ظ„ط³ط¨ط¨
      if(!(window.Html5Qrcode || ("BarcodeDetector" in window))){
        const m = 'ظ‡ط°ط§ ط§ظ„ظ…طھطµظپط­ ظ„ط§ ظٹط¯ط¹ظ… ظ…ط³ط­ QR ط¨ط§ظ„ظƒط§ظ…ظٹط±ط§. ط§ط³طھط®ط¯ظ… ط§ظ„ط¥ط¯ط®ط§ظ„ ط§ظ„ظٹط¯ظˆظٹ ط£ظˆ ط§ظپطھط­ ط§ظ„طµظپط­ط© ظپظٹ Chrome/Edge ط­ط¯ظٹط«.';
        const html = m + ` â€” <button class="pill" id="useImageScanBtn" type="button">ظ…ط³ط­ ظ…ظ† طµظˆط±ط©</button>`;
        showNoticeHtml(html, 'bad');
        setTimeout(()=>{ const b=document.getElementById('useImageScanBtn'); if(b) b.addEventListener('click', ()=>{ const inp=document.getElementById('scanImageInput'); if(inp) inp.click(); }); },0);
        return;
      }

      const isNotSecure = !!(err && (err.code==='NOT_SECURE' || err.name==='NOT_SECURE' || err.message==='NOT_SECURE'));
      const httpsUrl = suggestedHttpsUrl();
      const name = (err && (err.name||err.message)) ? (err.name||err.message) : '';

      if(isNotSecure){
        if(httpsUrl){
          const html = `ظ„ظ… ظٹطھظ… طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ„ط£ظ† ط§ظ„طµظپط­ط© ظ„ظٹط³طھ ط¢ظ…ظ†ط© (HTTP). ط³ظٹطھظ… طھط­ظˆظٹظ„ظƒ طھظ„ظ‚ط§ط¦ظٹط§ظ‹ ظ„ظ„ظ†ط³ط®ط© ط§ظ„ط¢ظ…ظ†ط©. ط¥ط°ط§ ظ„ظ… ظٹط­ط¯ط« ط§ظ„طھط­ظˆظٹظ„ ط§ط¶ط؛ط·: <button class="pill" id="openHttpsBtn" type="button">ظپطھط­ ط¹ط¨ط± HTTPS</button>`;
          showNoticeHtml(html + (name?(' <span class="muted">('+name+')</span>'):''), 'bad');
          setTimeout(()=>{
            const b = document.getElementById('openHttpsBtn');
            if(b) b.addEventListener('click', ()=>{ location.href = httpsUrl; });
          }, 0);
        }else{
          showNotice(`ظ„ظ… ظٹطھظ… طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ„ط£ظ† ط§ظ„طµظپط­ط© ظ„ظٹط³طھ ط¢ظ…ظ†ط©. ط§ظپطھط­ ط¹ط¨ط± https ط¹ظ„ظ‰ ط§ظ„ظ…ظ†ظپط° 3443 (ظ…ط«ط§ظ„: https://${location.hostname}:3443).`, 'bad');
        }
        return;
      }

      // ط£ط®ط·ط§ط، طµظ„ط§ط­ظٹط§طھ/ط§ط³طھط®ط¯ط§ظ… ط§ظ„ظƒط§ظ…ظٹط±ط§
      const n = (err && err.name) ? err.name : '';
      const msgAr = (n==='NotAllowedError' || n==='PermissionDeniedError')
        ? 'طھظ… ط±ظپط¶ ط¥ط°ظ† ط§ظ„ظƒط§ظ…ظٹط±ط§. ظ…ظ† ط¥ط¹ط¯ط§ط¯ط§طھ ط§ظ„ظ…طھطµظپط­: Site settings > Camera > Allow ط«ظ… ط­ط¯ظ‘ط« ط§ظ„طµظپط­ط©.'
        : (n==='NotFoundError')
          ? 'ظ„ط§ طھظˆط¬ط¯ ظƒط§ظ…ظٹط±ط§ ظ…طھط§ط­ط© ط¹ظ„ظ‰ ظ‡ط°ط§ ط§ظ„ط¬ظ‡ط§ط².'
          : (n==='NotReadableError')
            ? 'ط§ظ„ظƒط§ظ…ظٹط±ط§ ظ…ط´ط؛ظˆظ„ط© ط¨طھط·ط¨ظٹظ‚ ط¢ط®ط±. ط§ط؛ظ„ظ‚ ط£ظٹ طھط·ط¨ظٹظ‚ ظٹط³طھط®ط¯ظ… ط§ظ„ظƒط§ظ…ظٹط±ط§ ط«ظ… ط¬ط±ظ‘ط¨.'
            : 'طھط¹ط°ط± طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§. ط¬ط±ظ‘ط¨ ظپطھط­ ط§ظ„طµظپط­ط© ظپظٹ Chrome/Edge ظˆط§ط³ظ…ط­ ط¨ط¥ط°ظ† ط§ظ„ظƒط§ظ…ظٹط±ط§.';
      const html = `${msgAr}${name ? ' ('+name+')' : ''} â€” <button class="pill" id="useImageScanBtn" type="button">ظ…ط³ط­ ظ…ظ† طµظˆط±ط©</button>`;
      showNoticeHtml(html, 'bad');
      setTimeout(()=>{ const b=document.getElementById('useImageScanBtn'); if(b) b.addEventListener('click', ()=>{ const inp=document.getElementById('scanImageInput'); if(inp) inp.click(); }); },0);
    });
    await scanner.start();
    const btnStop = document.querySelector("#btnStopCam");
    if(btnStop) btnStop.disabled = false;
  }

  async function stopScanner(){
    if(!scanner) return;
    await scanner.stop();
    const btnStop = document.querySelector("#btnStopCam");
    if(btnStop) btnStop.disabled = true;
  }


  // -------------------- Stats (Charts) --------------------
  let statsChartInstance = null;
  function openStats(){ $("#statsBack").style.display = "grid"; }
  function closeStats(){
    $("#statsBack").style.display = "none";
    try{ if(statsChartInstance){ statsChartInstance.destroy(); statsChartInstance = null; } }catch(e){}
  }

  async function showStats(kind){
    // kind: cashiers | visits | ratings
    const r = await api('/api/admin/stats/rolling').catch(err=>err.data);
    if(!r || !r.ok){ showNotice('طھط¹ط°ط± طھط­ظ…ظٹظ„ ط§ظ„ط¥ط­طµط§ط¦ظٹط§طھ.', 'bad'); return; }
    const since = r.since;
    const days = r.windowDays;
    const title = (kind==='cashiers') ? 'ظ…ط³ط§ظ‡ظ…ط© ط§ظ„ظ…ط­ط§ط³ط¨ظٹظ†'
      : (kind==='visits') ? 'ط§ظ„ط²ظٹط§ط±ط§طھ / ط§ظ„ط§ط³طھط¨ط¯ط§ظ„'
      : 'طھظˆط²ظٹط¹ ط§ظ„طھظ‚ظٹظٹظ…ط§طھ';
    $("#statsModalTitle").textContent = title;
    $("#statsModalSub").textContent = `ط¢ط®ط± ${days} ظٹظˆظ… (ظ…ظ† ${since})`;

    // Prepare chart data
    const ctx = document.getElementById('statsChart').getContext('2d');
    try{ if(statsChartInstance){ statsChartInstance.destroy(); statsChartInstance = null; } }catch(e){}

    let config = null;
    let details = '';

    if(kind==='cashiers'){
      const rows = (r.cashierRows||[]).map(x=>({ name: x.cashier||'â€”', washes: Number(x.washes||0), avg: Number(x.avgRating||0) }));
      const labels = rows.map(x=>x.name);
      const washes = rows.map(x=>x.washes);
      config = {
        type: 'bar',
        data: { labels, datasets: [{ label: 'ط¹ط¯ط¯ ط§ظ„ط؛ط³ظ„ط§طھ', data: washes }] },
        options: { responsive: true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
      };
      details = rows.map(x=>`${x.name}: ${x.washes} ط؛ط³ظ„ط© â€” طھظ‚ظٹظٹظ… ${x.avg.toFixed(2)}`).join('\n') || 'ظ„ط§ طھظˆط¬ط¯ ط¨ظٹط§ظ†ط§طھ.';
    } else if(kind==='visits'){
      const earned = Number(r.earnedCount||0);
      const redeemed = Number(r.redeemedCount||0);
      config = {
        type: 'doughnut',
        data: { labels: ['ط¥ط¶ط§ظپط© ظ†ظ‚ط§ط·', 'ط§ط³طھط¨ط¯ط§ظ„'], datasets: [{ label:'', data:[earned, redeemed] }] },
        options: { responsive: true }
      };
      details = `ط¥ط¶ط§ظپط© ظ†ظ‚ط§ط·: ${earned}
ط§ط³طھط¨ط¯ط§ظ„: ${redeemed}`;
    } else {
      const dist = new Map((r.ratingDist||[]).map(x=>[String(x.rating), Number(x.c||0)]));
      const labels = ['1','2','3','4','5'];
      const data = labels.map(k=>dist.get(k)||0);
      config = {
        type: 'bar',
        data: { labels: labels.map(x=>x+'âک…'), datasets: [{ label:'ط¹ط¯ط¯ ط§ظ„طھظ‚ظٹظٹظ…ط§طھ', data }] },
        options: { responsive:true, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
      };
      details = labels.map(k=>`${k}âک…: ${dist.get(k)||0}`).join('\n');
    }

    // Render chart only if Chart.js is available
    if(window.Chart && config){
      statsChartInstance = new Chart(ctx, config);
    } else {
      showNotice('ظ…ظƒطھط¨ط© ط§ظ„ط¥ط­طµط§ط¦ظٹط§طھ ظ„ظ… طھظڈط­ظ…ظ‘ظ„ (Chart.js). طھط£ظƒط¯ ط£ظ† /vendor/chart.umd.js ظٹط¹ظ…ظ„.', 'bad');
    }

    $("#statsDetails").textContent = details;
    openStats();
  }

  (function bindUi(){
    // طھط´ط؛ظٹظ„ ط§ظ„ظƒط§ظ…ظٹط±ط§ ظٹطھط·ظ„ط¨ ط¶ط؛ط· ط²ط± ظپظٹ ط¨ط¹ط¶ ط§ظ„ظ…طھطµظپط­ط§طھ
    const btnCam = document.querySelector("#btnCam");
    const btnStop = document.querySelector("#btnStopCam");
    if(btnCam) btnCam.addEventListener("click", async ()=>{
      await startScanner();
      if(btnStop) btnStop.disabled = false;
    });
    if(btnStop) btnStop.addEventListener("click", async ()=>{
      await stopScanner();
      btnStop.disabled = true;
    });

    // Scan from an image (works even if camera is blocked or on iPhone)
    const btnImg = document.getElementById('btnScanImage');
    const imgInp = document.getElementById('scanImageInput');
    if(btnImg && imgInp){
      btnImg.addEventListener('click', ()=> imgInp.click());
      imgInp.addEventListener('change', async (e)=>{
        const f = e.target.files && e.target.files[0];
        if(!f) return;
        try{
          let decoded = null;

          if(window.Html5Qrcode){
            const tmpId = 'qr_img_' + Math.random().toString(16).slice(2);
            const tmp = document.createElement('div');
            tmp.id = tmpId;
            tmp.style.display = 'none';
            document.body.appendChild(tmp);
            const h = new Html5Qrcode(tmpId);
            try{
              decoded = await h.scanFile(f, true);
            } finally {
              try{ h.clear(); }catch(_e){}
              try{ tmp.remove(); }catch(_e){}
            }
          } else if('BarcodeDetector' in window){
            const img = await createImageBitmap(f);
            const det = new BarcodeDetector({formats:['qr_code']});
            const codes = await det.detect(img);
            decoded = (codes && codes[0] && codes[0].rawValue) ? codes[0].rawValue : null;
          } else {
            throw new Error('NO_SUPPORT');
          }

          if(!decoded) throw new Error('NO_CODE');
          playScanBeep();
          const r = await api('/api/visit/lookup','POST',{ qrText: decoded }).catch(err=>err.data);
          if(r.ok){ applyLookup(r); showNotice('طھظ… ط¬ظ„ط¨ ط¨ظٹط§ظ†ط§طھ ط§ظ„ط²ظٹط§ط±ط©.', 'good'); }
          else{ showNotice('QR ط؛ظٹط± طµط§ظ„ط­ ط£ظˆ ظ…ظ†طھظ‡ظٹ.', 'bad'); }
        }catch(err){
          const msg = (err && err.message === 'NO_SUPPORT')
            ? 'ظ‡ط°ط§ ط§ظ„ظ…طھطµظپط­ ظ„ط§ ظٹط¯ط¹ظ… ظ…ط³ط­ QR ظ…ظ† طµظˆط±ط©. ط§ظپطھط­ ط§ظ„طµظپط­ط© ظپظٹ Chrome/Edge ط­ط¯ظٹط«.'
            : 'طھط¹ط°ط± ظ…ط³ط­ ط§ظ„طµظˆط±ط©.';
          showNotice(msg, 'bad');
        } finally { e.target.value=''; }
      });
    }



    // Stats tiles
    const bCash = document.getElementById('openStatsCashiers');
    const bVisits = document.getElementById('openStatsVisits');
    const bRates = document.getElementById('openStatsRatings');
    if(bCash) bCash.addEventListener('click', ()=>showStats('cashiers'));
    if(bVisits) bVisits.addEventListener('click', ()=>showStats('visits'));
    if(bRates) bRates.addEventListener('click', ()=>showStats('ratings'));
    // Clear notifications (ط§ظ„ظƒظ„)
    const clearBtn = document.getElementById("clearNotiBtn");
    if(clearBtn){
      clearBtn.addEventListener("click", async ()=>{
        const r = await api("/api/admin/notifications/clear", "POST", {});
        if(r.ok){ showNotice("طھظ… ط­ط°ظپ ط§ظ„ط¥ط´ط¹ط§ط±ط§طھ.", "good"); await updateNotiBadge(); }
      });
    }
  })();

  (async ()=>{
    // ط£ظٹ ط®ط·ط£ ظپظٹ ط§ظ„ط¬ظ„ط¨ ظ„ط§ ظٹط¬ط¨ ط£ظ† ظٹط¹ط·ظ‘ظ„ ط§ظ„ط£ط²ط±ط§ط±/ط§ظ„ظƒط§ظ…ظٹط±ط§
    try{
      await guard();
    }catch(e){
      showNotice("ط§ظ„ط±ط¬ط§ط، طھط³ط¬ظٹظ„ ط§ظ„ط¯ط®ظˆظ„ ظ…ط±ط© ط£ط®ط±ظ‰.", "bad");
      location.href="/admin-login.html";
      return;
    }

    try{ await loadDashboard(); }catch(e){ showNotice("طھط¹ط°ط± طھط­ظ…ظٹظ„ ظ„ظˆط­ط© ط§ظ„طھط­ظƒظ….", "bad"); }
    try{ await updateNotiBadge(); }catch(e){}
    setInterval(()=>{ updateNotiBadge().catch(()=>{}); }, 1000);

    // طھط­ط¯ظٹط« ظپظˆط±ظٹ ظ„ظ„ط¨ط§ط¯ط¬ ط¹ط¨ط± SSE (ط§ط®طھظٹط§ط±ظٹ)
    try{
      const es = new EventSource('/api/admin/notifications/stream');
      let fail = 0;

      es.addEventListener('count', (ev)=>{
        try{
          const data = JSON.parse(ev.data||'{}');
          const c = Number(data.count||0);
          const b = document.getElementById('notiBadge');
          if(b){ b.textContent = c>99 ? '99+' : String(c); b.style.display = c? 'inline-flex':'none'; }
          fail = 0;
        }catch(e){}
      });

      // ط¥ط°ط§ ظپط´ظ„ SSE (401/ط´ط¨ظƒط©/ط´ظ‡ط§ط¯ط©) ظ„ط§ ظ†طھط±ظƒظ‡ ظٹط¹ظٹط¯ ط§ظ„ظ…ط­ط§ظˆظ„ط© ظ„ظ„ط£ط¨ط¯
      es.onerror = ()=>{
        fail += 1;
        if(fail >= 3){
          try{ es.close(); }catch(e){}
        }
      };
    }catch(e){}
  })();
</script>
</body>
</html>



